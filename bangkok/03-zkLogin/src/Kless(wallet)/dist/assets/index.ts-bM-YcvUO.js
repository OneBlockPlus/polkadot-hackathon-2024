var q=n=>{throw TypeError(n)};var O=(n,e,t)=>e.has(n)||q("Cannot "+t);var l=(n,e,t)=>(O(n,e,"read from private field"),t?t.call(n):e.get(n)),x=(n,e,t)=>e.has(n)?q("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t);import{i as S,O as U,c as b,o as L,m,t as h,s as C,f as E,S as D,v as I,a as u}from"./Message-BmumhDZC.js";import{P,f as H,B as i}from"./PortStream-DB5rsuAT.js";import{i as w,g as A,B as $}from"./db-A60k3ZnO.js";import{l as B}from"./lastValueFrom-DQrRdIu3.js";var j=Array.isArray;function F(n){return n.length===1&&j(n[0])?n[0]:n}function W(){for(var n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return n=F(n),n.length===1?S(n[0]):new U(G(n))}function G(n){return function(e){for(var t=[],s=function(a){t.push(S(n[a]).subscribe(b(e,function(o){if(t){for(var c=0;c<t.length;c++)c!==a&&t[c].unsubscribe();t=null}e.next(o)})))},r=0;t&&!e.closed&&r<n.length;r++)s(r)}}function J(n,e){return e===void 0&&(e=!1),L(function(t,s){var r=0;t.subscribe(b(s,function(a){var o=n(a,r++);(o||e)&&s.next(a),!o&&s.complete()}))})}function z(n){return w(n)&&n.type==="get-account"}class _{constructor(e){this._portStream=new P(e),this._portStream.onMessage.subscribe(t=>this.handleMessage(t))}get onDisconnect(){return this._portStream.onDisconnect.pipe(m(e=>({port:e})),h(1))}send(e){if(this._portStream.connected)return this._portStream.sendMessage(e)}}function K(n){return w(n)&&n.type==="sign-transaction-request"}const V=async()=>(await A()).accounts.toCollection().sortBy("createdAt"),X=320,Y=560,Q=H(n=>i.windows.onRemoved.addListener(n),n=>i.windows.onRemoved.removeListener(n)).pipe(C()),Z=Y+28;class ee{constructor(e){this._id=null,this._url=e}async show(){const{width:e=0,left:t=0,top:s=0}=await i.windows.getLastFocused(),r=await i.windows.create({url:this._url,focused:!0,width:X,height:Z,type:"popup",top:s,left:Math.floor(t+e-450)});return this._id=typeof r.id>"u"?null:r.id,Q.pipe(J(()=>this._id!==null),E(a=>a===this._id),h(1))}async close(){this._id!==null&&await i.windows.remove(this._id)}get id(){return this._id}}const te=1e3*60*60*3,f="transactions";function se(n){return new ee(i.runtime.getURL("index.html")+`#/approve/${encodeURIComponent(n)}`)}class ne{constructor(){this._txResponseMessages=new D}async executeOrSignTransaction({tx:e},t){const{txResultError:s,txResult:r,txSigned:a}=await this.requestApproval(e,t.origin);if(s)throw new Error(`Transaction failed with the following error. ${s}`);if(!a)throw new Error("Transaction signature is empty");return e?r:a}async signMessage({accountAddress:e,message:t},s){const{txResult:r,txResultError:a}=await this.requestApproval({type:"sign-message",accountAddress:e,message:t},s.origin);if(a)throw new Error(`${a}`);if(!r)throw new Error("Sign message result is empty");if(!("messageBytes"in r))throw new Error("Sign message error, unknown result");return r}async getTransactionRequests(){return(await i.storage.local.get({[f]:{}}))[f]}async getTransactionRequest(e){return(await this.getTransactionRequests())[e]||null}handleMessage(e){this._txResponseMessages.next(e)}async clearStaleTransactions(){const e=Date.now(),t=await this.getTransactionRequests();let s=!1;Object.keys(t).forEach(r=>{const a=t[r],o=new Date(a.createdDate);(a.approved!==null||e-o.getTime()>=te)&&(delete t[r],s=!0)}),s&&await this.saveTransactionRequests(t)}createTransactionRequest(e,t,s){return{id:I(),approved:null,origin:t,originFavIcon:s,createdDate:new Date().toISOString(),tx:e}}async saveTransactionRequests(e){await i.storage.local.set({[f]:e})}async storeTransactionRequest(e){const t=await this.getTransactionRequests();t[e.id]=e,await this.saveTransactionRequests(t)}async removeTransactionRequest(e){const t=await this.getTransactionRequests();delete t[e],await this.saveTransactionRequests(t)}async requestApproval(e,t){const s=this.createTransactionRequest(e,t);await this.storeTransactionRequest(s);const a=(await se(s.id).show()).pipe(h(1),m(()=>!1)),o=this._txResponseMessages.pipe(E(c=>c.txID===s.id),h(1));return B(W(a,o).pipe(h(1),m(async c=>{if(await this.removeTransactionRequest(s.id),c){const{approved:v,txResult:k,txSigned:M,txResultError:N}=c;if(v)return s.approved=v,s.txResult=k,s.txResultError=N,s.txSigned=M,console.log("Approved from user",s),s}throw new Error("Rejected from user")})))}}const y=new ne,R=class R extends _{constructor(e){var t,s;super(e),this.origin=this.getOrigin(e),this.pagelink=this.getAppUrl(e),this.originFavIcon=(s=(t=e.sender)==null?void 0:t.tab)==null?void 0:s.favIconUrl}async handleMessage(e){const{payload:t}=e;console.log("ContentScriptConnection.handleMessage",e);try{if(z(t)){const s=await V();await this.sendAccounts(s.map(r=>({address:r.address,genesisHash:"",name:r.nickname,type:"sr25519"})),e.id)}else if(K(t)){const r=await(await A()).accounts.get({address:t.transaction.address}),a=Number(t.transaction.blockNumber)>Number(r==null?void 0:r.epoch);if(console.log(Number(t.transaction.blockNumber),Number(r==null?void 0:r.epoch)),a)throw console.log("Account is locked"),new Error("Account is locked");const o=await y.executeOrSignTransaction({tx:t.transaction},this);this.send(u({type:"execute-transaction-response",result:o},e.id))}else throw new Error(`Unknown message, ${JSON.stringify(e.payload)}`)}catch(s){console.error(s),this.sendError({error:!0,code:-1,message:s.message},e.id)}}permissionReply(e,t){if(e.origin!==this.origin)return;const s=t||e.requestMsgID;e.allowed?this.send(u({type:"acquire-permissions-response",result:!!e.allowed},s)):this.sendError({error:!0,message:"Permission rejected",code:-1},s)}getOrigin(e){var t,s;if((t=e.sender)!=null&&t.origin)return e.sender.origin;if((s=e.sender)!=null&&s.url)return new URL(e.sender.url).origin;throw new Error("[ContentScriptConnection] port doesn't include an origin")}getAppUrl(e){var t;if((t=e.sender)!=null&&t.url)return new URL(e.sender.url).href}sendError(e,t){this.send(u(e,t))}async sendAccounts(e,t){this.send(u({type:"get-account-response",accounts:e},t))}};R.CHANNEL="kless_content<->background";let g=R;function re(n){return w(n)&&n.type==="get-transaction-requests"}function ae(n){return w(n)&&n.type==="transaction-request-response"}const T=class T extends _{constructor(e){super(e),this.uiAppInitialized=new $(!1)}async notifyEntitiesUpdated(e){this.send(u({type:"method-payload",method:"entitiesUpdated",args:{type:e}}))}async handleMessage(e){console.log("UiConnection.handleMessage",e);const{payload:t,id:s}=e;try{if(ae(t))y.handleMessage(t);else if(re(t))this.sendTransactionRequests(Object.values(await y.getTransactionRequests()),s);else throw new Error(`Unhandled message ${e.id}. (${JSON.stringify("error"in t?`${t.code}-${t.message}`:t.type)})`)}catch(r){this.send(u({error:!0,code:-1,message:r.message},s))}}sendPermissions(e,t){this.send(u({type:"permission-request",permissions:e},t))}sendTransactionRequests(e,t){this.send(u({type:"get-transaction-requests-response",txRequests:e},t))}};T.CHANNEL="kless_ui<->background";let p=T;new URL(i.runtime.getURL("")).origin;var d;class oe{constructor(){x(this,d,[]);i.runtime.onConnect.addListener(e=>{try{let t;switch(e.name){case g.CHANNEL:t=new g(e);break;case p.CHANNEL:t=new p(e);break;default:throw new Error(`[Connections] Unknown connection ${e.name}`)}l(this,d).push(t),t.onDisconnect.subscribe(()=>{const s=l(this,d).indexOf(t);s>=0&&l(this,d).splice(s,1)})}catch(t){console.error(t)}})}notifyContentScript(e,t){for(const s of l(this,d))if(s instanceof g)switch(e.event){case"permissionReply":s.permissionReply(e.permission);break;case"walletStatusChange":(!("origin"in e)||s.origin===e.origin)&&s.send(u({type:"wallet-status-changed",...e.change}));break}}}d=new WeakMap;new oe;
